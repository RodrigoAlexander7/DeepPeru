generator client {
  provider = "prisma-client-js"
}

generator docs {
  provider = "node ./node_modules/prisma-docs-generator"
  output   = "../docs/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

/// User Table with extended personal data
/// - Leagal identity fields are not required when the user is a tourist
model User {
  id        String    @id @default(cuid())
  email     String?   @unique
  image     String?
  accounts  Account[]
  sessions  Session[]
  isActive  Boolean   @default(true) /// Whether the user is active
  name      String
  /// When the record was created
  createdAt DateTime  @default(now())
  /// When the record was last updated
  updatedAt DateTime  @updatedAt

  // Personal data
  phoneId           Int?
  phone             Phone?    @relation(fields: [phoneId], references: [id])
  firstName         String? /// Exameple: John, Alvaro Raúl
  lastName          String? /// Example: Doe, Gómez Pérez
  gender            Gender?
  dateOfBirth       DateTime? /// Example: "1990-05-20T00:00:00.000Z"
  nationalityId     Int? /// Reference to Country, also used for document number
  nationality       Country?  @relation(fields: [nationalityId], references: [id], name: "UserNationality")
  documentNumber    String? /// National ID, Example: DNI, 12345678 in Peru, relies on nationality
  passportNumber    String?   @unique /// Passport number for international travel
  passportCountryId Int? // Reuses Country table
  passportCountry   Country?  @relation(fields: [passportCountryId], references: [id], name: "PassportCountry")

  // Relations
  systemAdmin    SystemAdmin?
  companyAdmin   CompanyAdmin?
  tourismWorkers CompanyWorker[]
  tourist        Tourist?
}

// Global system administrator model
model SystemAdmin {
  id        Int      @id @default(autoincrement())
  userId    String   @unique
  user      User     @relation(fields: [userId], references: [id])
  createdAt DateTime @default(now())
}

// Company administrator model, user who manages a tourism company
model CompanyAdmin {
  id               Int              @id @default(autoincrement())
  userId           String           @unique
  user             User             @relation(fields: [userId], references: [id])
  company          TourismCompany[]
  createdAt        DateTime         @default(now())
  tourismCompanyId Int
}

model Tourist {
  id               Int       @id @default(autoincrement())
  userId           String    @unique
  languageId       Int? /// Preferred language ID
  currencyId       Int? /// Preferred currency ID
  emergencyPhoneId Int? /// Emergency contact phone number
  // Relations
  user             User      @relation(fields: [userId], references: [id])
  language         Language? @relation(fields: [languageId], references: [id])
  currency         Currency? @relation(fields: [currencyId], references: [id])
  emergencyPhone   Phone?    @relation(fields: [emergencyPhoneId], references: [id])
}

model CompanyWorker {
  id        Int     @id @default(autoincrement())
  userId    String
  companyId Int
  role      String?
  isActive  Boolean @default(true)

  user        User           @relation(fields: [userId], references: [id])
  company     TourismCompany @relation(fields: [companyId], references: [id])
  permissions Permission[]   @relation("WorkerPermissions")

  @@unique([userId, companyId])
}

model Permission {
  id      Int             @id @default(autoincrement())
  name    String          @unique /// e.g. "CREATE_PACKAGE", "VIEW_BOOKINGS"
  workers CompanyWorker[] @relation("WorkerPermissions")
}

enum Gender {
  MALE /// Masculino
  FEMALE /// Femenino  
  UNKN // Not specified
}

model Phone {
  id        Int       @id
  number    String
  countryId Int
  country   Country   @relation(fields: [countryId], references: [id])
  users     User[]
  tourists  Tourist[]
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

/// ===============================
/// Language Table
/// ===============================

/// Represents a supported language in the system.
/// Use ISO 639-1 two-letter codes: e.g. "en", "es", "fr".
/// This table allows linking translatable content to specific languages.
model Language {
  id                  Int                         @id @default(autoincrement())
  /// ISO 639-1 code (unique)
  /// Example: "en"
  code                String                      @unique
  /// Display name for human readability
  /// Example: "English", "Español", "日本語"
  name                String
  /// Companies that use this language as default
  companies           TourismCompany[]
  /// Optional translations linked to this language
  companyTranslations TourismCompanyTranslation[]
  countryTranslations CountryTranslation[]
  regionTranslations  RegionTranslation[]
  cityTranslations    CityTranslation[]
  tourist             Tourist[]

  TouristPackage TouristPackage[]

  TouristPackageTranslation TouristPackageTranslation[]

  PackageLanguage PackageLanguage[]
}

/// ===============================
/// Tourism Company Table
/// ===============================

/// Represents a tourism company (brand or organization).
/// A company may have multiple physical installations (offices, hotels, etc.)
/// and multilingual information via the related translation table.
model TourismCompany {
  id                 Int                         @id @default(autoincrement())
  /// Commercial name of the company
  name               String
  /// Legal or registered business name (optional)
  legalName          String?
  /// Business registration number: RUC, VAT, RFC, etc.
  registrationNumber String?
  /// Main contact email (required)
  email              String
  /// Main contact phone (required)
  phone              String
  /// Official website
  websiteUrl         String?
  /// Logo URL (optional)
  logoUrl            String?
  /// Official registration date (legal or administrative)
  /// Example: "2025-01-15T00:00:00.000Z"
  registerDate       DateTime
  /// Whether the company is active in the system
  isActive           Boolean                     @default(true)
  /// Average rating from users or agencies
  rating             Float?
  /// Default language for the company (ISO code, e.g., "en", "es")
  languageId         Int?
  language           Language?                   @relation(fields: [languageId], references: [id])
  /// Locations (branches, offices, hotels, etc.)
  installations      CompanyInstallation[]
  /// Multilingual descriptions or taglines
  translations       TourismCompanyTranslation[]
  /// When the record was created
  createdAt          DateTime                    @default(now())
  /// When the record was last updated
  updatedAt          DateTime                    @updatedAt
  adminId            Int
  admin              CompanyAdmin                @relation(fields: [adminId], references: [id])
  workers            CompanyWorker[]

  TouristPackage TouristPackage[]
}

/// ===============================
/// Tourism Company Translation Table
/// ===============================

/// Stores translations for tourism companies.
/// Only fields that vary by language are placed here (e.g. description, tagline).
model TourismCompanyTranslation {
  id          Int     @id @default(autoincrement())
  companyId   Int
  languageId  Int
  /// Description of services, history, etc. (localized)
  description String?
  /// Short tagline or slogan (localized)
  tagline     String?

  company  TourismCompany @relation(fields: [companyId], references: [id])
  language Language       @relation(fields: [languageId], references: [id])

  @@unique([companyId, languageId]) // Ensures one translation per language per company
}

/// ===============================
/// Company Installation Table
/// ===============================

/// Represents a physical location (branch, office, hotel, etc.)
/// Each company can have one or more installations.
/// Includes geographic coordinates for use in Google Maps or similar apps.
model CompanyInstallation {
  id           Int            @id @default(autoincrement())
  /// Installation name or label
  /// Example: "Main Office", "Cusco Branch"
  name         String
  /// Address or description of the location
  /// Example: "Av. Arequipa 1200, Miraflores"
  address      String
  /// Latitude coordinate for map location
  /// Example: -16.3989
  latitude     Float
  /// Longitude coordinate for map location
  /// Example: -71.5350
  longitude    Float
  /// Optional relation to a postal code (if structured location is used)
  postalCodeId Int?
  postalCode   PostalCode?    @relation(fields: [postalCodeId], references: [id])
  /// Relation to the parent company
  companyId    Int
  company      TourismCompany @relation(fields: [companyId], references: [id])
  /// Whether this location is active
  isActive     Boolean        @default(true)
  /// Record creation timestamp
  createdAt    DateTime       @default(now())
  /// Record last update timestamp
  updatedAt    DateTime       @updatedAt
}

/// ===============================
/// Country Table
/// ===============================

/// Represents a country.
/// Supports multilingual display names via CountryTranslation.
model Country {
  id                   Int                  @id @default(autoincrement())
  /// ISO 3166-1 alpha-2 code, e.g., "PE"
  code                 String               @unique
  /// Default (fallback) name, e.g., "Peru"
  name                 String               @unique
  /// International phone prefix, e.g., "+51"
  phoneCode            String?
  /// Currency reference
  currencyId           Int?
  currency             Currency?            @relation(fields: [currencyId], references: [id])
  regions              Region[]
  translations         CountryTranslation[]
  /// Relations to phone
  phones               Phone[]
  usersNationalities   User[]               @relation("UserNationality")
  usersPassportCountry User[]               @relation("PassportCountry")
}

/// Country name translations, to show country names in different languages
/// Example: "Germany" in English, "Deutschland" in German
model CountryTranslation {
  id         Int      @id @default(autoincrement())
  countryId  Int
  languageId Int
  name       String
  country    Country  @relation(fields: [countryId], references: [id])
  language   Language @relation(fields: [languageId], references: [id])

  @@unique([countryId, languageId])
}

/// ===============================
/// Region Table
/// ===============================

/// Represents a region, state, or department.
/// Supports multilingual names via RegionTranslation.
model Region {
  id           Int                 @id @default(autoincrement())
  name         String
  code         String?
  countryId    Int
  country      Country             @relation(fields: [countryId], references: [id])
  cities       City[]
  translations RegionTranslation[]
}

/// Region name translations
/// to show region names in different languages
/// Example: "Tokyo" in English, "東京" in Japanese
model RegionTranslation {
  id         Int      @id @default(autoincrement())
  regionId   Int
  languageId Int
  name       String
  region     Region   @relation(fields: [regionId], references: [id])
  language   Language @relation(fields: [languageId], references: [id])

  @@unique([regionId, languageId])
}

/// ===============================
/// City Table
/// ===============================

/// Represents a city.
/// Supports multilingual display names via CityTranslation.
model City {
  id           Int               @id @default(autoincrement())
  name         String
  regionId     Int
  region       Region            @relation(fields: [regionId], references: [id])
  postalCodes  PostalCode[]
  translations CityTranslation[]
}

/// City name translations
/// for showing city names in different languages
/// Example: "Tokyo" in English, "東京" in Japanese
model CityTranslation {
  id         Int      @id @default(autoincrement())
  cityId     Int
  languageId Int
  name       String
  city       City     @relation(fields: [cityId], references: [id])
  language   Language @relation(fields: [languageId], references: [id])

  @@unique([cityId, languageId])
}

/// ===============================
/// Postal Code Table
/// ===============================

/// Represents postal codes linked to cities.
/// Useful for structuring addresses.
model PostalCode {
  id            Int                   @id @default(autoincrement())
  /// Postal code (e.g., "04001")
  code          String
  /// Relation to the city
  cityId        Int
  city          City                  @relation(fields: [cityId], references: [id])
  installations CompanyInstallation[]
}

/// ===============================
/// Currency Table
/// ===============================

/// Represents a currency used by one or more countries.
/// Follows ISO 4217 codes.
model Currency {
  id        Int       @id @default(autoincrement())
  /// Full currency name, e.g., "Peruvian Sol"
  name      String
  /// ISO 4217 code, e.g., "PEN"
  code      String
  /// Symbol used, e.g., "S/"
  symbol    String?
  countries Country[]
  tourists  Tourist[]

  PricingOption PricingOption[]
}

/// ===============================
/// Tourist Package Table (normalized)
/// ===============================

/// Represents a tourist package offered by a company.
/// Includes metadata, relations, pricing, schedules, and multilingual content.
/// Standards:
/// - Date/time: ISO 8601 (e.g., "2025-01-15T10:00:00Z").
/// - Durations: ISO 8601 Duration (e.g., "PT2H30M").
/// - Time zone: IANA Time Zone (e.g., "America/Lima").
/// - Currency: ISO 4217 (Currency table).
model TouristPackage {
  id        Int            @id @default(autoincrement())
  /// Company offering the package
  companyId Int
  company   TourismCompany @relation(fields: [companyId], references: [id])

  /// Default name (fallback when no translation is available)
  name        String
  /// Default description (fallback)
  description String?

  /// Total tour duration (ISO 8601 Duration, e.g., "P1D" or "PT6H")
  duration String?

  /// Package type (private, group, self-guided)
  type       PackageType      @default(GROUP)
  /// Physical difficulty level
  difficulty DifficultyLevel?

  /// Default content language (ISO 639-1)
  languageId     Int?
  language       Language?         @relation(fields: [languageId], references: [id])
  /// Languages offered for guiding/operation
  guideLanguages PackageLanguage[]

  /// Average rating
  rating   Float?
  /// Publication/sale status
  isActive Boolean @default(true)

  /// Age restrictions
  minAge Int?
  maxAge Int?

  /// Group size constraints
  minParticipants Int?
  maxParticipants Int?

  /// Meeting point (free text)
  meetingPoint     String?
  /// Meeting point coordinates (WGS84)
  meetingLatitude  Float?
  meetingLongitude Float?

  /// End point (free text)
  endPoint     String?
  /// End point coordinates (WGS84)
  endLatitude  Float?
  endLongitude Float?

  /// Time zone for schedules (IANA, e.g., "America/Lima")
  timezone String?

  /// Minimum advance booking time (ISO 8601 Duration, e.g., "PT24H")
  bookingCutoff String?

  /// Requirements (documents, clothing, etc.)
  requirements       String[]
  /// Safety information
  safetyInfo         String?
  /// Additional information
  additionalInfo     String?
  /// Cancellation policy (text)
  cancellationPolicy String?
  /// Cancellation policy type
  cancellationType   CancellationPolicyType?

  /// Included/excluded items
  includedItems String[]
  excludedItems String[]

  /// Package highlights/benefits
  benefits             Benefit[]
  /// Detailed features of the package
  features             Feature[]
  /// Itineraries (supports multiple variations)
  itineraries          Itinerary[]
  /// Pickup details (hotel, radius, time window)
  pickupDetails        PickupDetail[]
  /// Accessibility options (enum list)
  accessibilityOptions AccessibilityFeature[]

  /// Media (images, videos, documents)
  media          Media[]
  /// Price options (by age, private/group, validity)
  pricingOptions PricingOption[]
  /// Recurring schedules/shifts
  schedules      Schedule[]

  /// Translations by language
  translations TouristPackageTranslation[]

  /// Audit timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([companyId])
}

/// ===============================
/// Enums for Tourist Packages
/// ===============================

/// Package type
enum PackageType {
  GROUP /// Shared group service
  PRIVATE /// Private service
  SELF_GUIDED /// Self-guided (no guide)
}

/// Physical difficulty level (indicative)
enum DifficultyLevel {
  EASY /// Easy (suitable for most)
  MODERATE /// Moderate
  CHALLENGING /// Challenging
  HARD /// Hard
}

/// Accessibility features (non-exhaustive list)
enum AccessibilityFeature {
  WHEELCHAIR_ACCESSIBLE /// Wheelchair accessible
  STROLLER_ACCESSIBLE /// Stroller accessible
  SERVICE_ANIMALS_ALLOWED /// Service animals allowed
  AUDIO_GUIDE_AVAILABLE /// Audio guide available
  SIGN_LANGUAGE_AVAILABLE /// Sign language available
  LARGE_PRINT_MATERIAL /// Large print material
  ASSISTIVE_LISTENING_SYSTEM /// Assistive listening system
  BRAILLE_MATERIAL /// Braille material
  STEP_FREE_ACCESS /// Step-free access
  ELEVATOR_AVAILABLE /// Elevator available
  ACCESSIBLE_TOILET /// Accessible restroom
}

/// Cancellation policy type
enum CancellationPolicyType {
  FLEXIBLE /// Broad refunds with short notice
  MODERATE /// Refunds with medium notice
  STRICT /// Refunds with long notice
  NON_REFUNDABLE /// Non-refundable
}

/// Days of week for recurring schedules
enum DayOfWeek {
  MON
  TUE
  WED
  THU
  FRI
  SAT
  SUN
}

/// Media type associated with the package
enum MediaType {
  IMAGE
  VIDEO
  DOCUMENT
}

/// ===============================
/// Benefit (highlights)
/// ===============================

/// Individual package benefit (icon, title, text).
model Benefit {
  id        Int            @id @default(autoincrement())
  packageId Int
  package   TouristPackage @relation(fields: [packageId], references: [id])

  /// Icon URL (SVG/PNG)
  iconUrl   String?
  /// Benefit title
  title     String
  /// Descriptive text
  text      String?
  /// Display order
  order     Int?
  createdAt DateTime @default(now())

  @@index([packageId])
}

/// ===============================
/// Feature (detailed characteristics)
/// ===============================

/// Package feature (name, icon, description, category).
model Feature {
  id        Int            @id @default(autoincrement())
  packageId Int
  package   TouristPackage @relation(fields: [packageId], references: [id])

  /// Feature category (e.g., "Transport", "Lodging")
  category    String?
  /// Icon URL
  iconUrl     String?
  /// Feature name
  name        String
  /// Extended description
  description String?
  /// Display order
  order       Int?
  createdAt   DateTime @default(now())

  @@index([packageId])
}

/// ===============================
/// Itinerary (days/activities structure)
//  ===============================

/// Package itinerary (can vary by season).
model Itinerary {
  id        Int            @id @default(autoincrement())
  packageId Int
  package   TouristPackage @relation(fields: [packageId], references: [id])

  /// Itinerary title (e.g., "3-day Itinerary")
  title String?
  /// Total number of days
  days  Int?
  /// Items (day/activity)
  items ItineraryItem[]

  createdAt DateTime @default(now())

  @@index([packageId])
}

/// Itinerary item with day, time, and location.
/// Notes:
/// - startTime/endTime as ISO 8601 time "HH:mm" (24h).
/// - Coordinates in WGS84.
model ItineraryItem {
  id          Int       @id @default(autoincrement())
  itineraryId Int
  itinerary   Itinerary @relation(fields: [itineraryId], references: [id])

  /// Relative day (starting at 1)
  dayNumber   Int
  /// Activity/stop title
  title       String
  /// Activity description
  description String?

  /// Start time (ISO 8601 "HH:mm")
  startTime String?
  /// End time (ISO 8601 "HH:mm")
  endTime   String?

  /// Textual location
  location  String?
  /// Coordinates (WGS84)
  latitude  Float?
  longitude Float?

  /// Order within the day
  order Int?

  @@index([itineraryId])
  @@index([dayNumber])
}

/// ===============================
/// Pickup Details
/// ===============================

/// Pickup/return details (hotel, radius, time window).
/// Times in ISO 8601 "HH:mm".
model PickupDetail {
  id        Int            @id @default(autoincrement())
  packageId Int
  package   TouristPackage @relation(fields: [packageId], references: [id])

  /// Whether hotel pickup is offered
  isHotelPickupAvailable Boolean @default(false)
  /// Pickup radius in km
  pickupRadiusKm         Float?
  /// Pickup area description
  pickupAreaDescription  String?

  /// Pickup time window (start/end)
  pickupStartTime String?
  pickupEndTime   String?

  /// Specific instructions
  instructions String?

  @@index([packageId])
}

/// ===============================
/// Media (images/videos/documents)
/// ===============================

/// Media attached to the package.
/// URLs should be stable (CDN/HTTPS).
model Media {
  id        Int            @id @default(autoincrement())
  packageId Int
  package   TouristPackage @relation(fields: [packageId], references: [id])

  type      MediaType @default(IMAGE)
  url       String
  caption   String?
  order     Int?
  isPrimary Boolean   @default(false)
  createdAt DateTime  @default(now())

  @@index([packageId])
}

/// ===============================
/// Pricing Options
/// ===============================

/// Price options by segment (adult/child/private group).
/// Standards:
/// - Currency: ISO 4217 (Currency table).
/// - Validity windows in ISO 8601 DateTime.
model PricingOption {
  id        Int            @id @default(autoincrement())
  packageId Int
  package   TouristPackage @relation(fields: [packageId], references: [id])

  /// Rate name (e.g., "Adult", "Child", "Private")
  name        String
  description String?

  /// Currency (ISO 4217)
  currencyId Int
  currency   Currency @relation(fields: [currencyId], references: [id])

  /// Amount in currency units (Decimal for accuracy)
  amount Decimal @db.Decimal(12, 2)

  /// True if price is per person; false if per group
  perPerson Boolean @default(true)

  /// Group constraints (if applicable)
  minParticipants Int?
  maxParticipants Int?

  /// Validity window
  validFrom DateTime?
  validTo   DateTime?

  /// Active status
  isActive Boolean @default(true)

  @@index([packageId])
  @@index([currencyId])
}

/// ===============================
/// Schedules
/// ===============================

/// Recurring package schedules.
/// - daysOfWeek: active days.
/// - startTime/endTime: ISO 8601 time "HH:mm".
/// - timezone: IANA TZ (e.g., "America/Lima").
model Schedule {
  id        Int            @id @default(autoincrement())
  packageId Int
  package   TouristPackage @relation(fields: [packageId], references: [id])

  timezone   String
  daysOfWeek DayOfWeek[]
  startTime  String
  endTime    String?
  notes      String?

  @@index([packageId])
}

/// ===============================
/// Translations (multilingual content)
/// ===============================

/// Translations of variable content per language.
/// Language: ISO 639-1 (Language table).
model TouristPackageTranslation {
  id         Int @id @default(autoincrement())
  packageId  Int
  languageId Int

  name               String?
  description        String?
  meetingPoint       String?
  endPoint           String?
  additionalInfo     String?
  cancellationPolicy String?

  /// Localized lists
  requirements  String[]
  includedItems String[]
  excludedItems String[]

  package  TouristPackage @relation(fields: [packageId], references: [id])
  language Language       @relation(fields: [languageId], references: [id])

  @@unique([packageId, languageId])
}

/// ===============================
/// Guide languages (M:N with Language)
/// ===============================

/// Languages in which the tour is guided/operated.
/// ISO 639-1 referenced from Language.
model PackageLanguage {
  packageId  Int
  languageId Int

  package  TouristPackage @relation(fields: [packageId], references: [id])
  language Language       @relation(fields: [languageId], references: [id])

  @@id([packageId, languageId])
}
